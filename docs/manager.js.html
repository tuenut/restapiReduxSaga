<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: manager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: manager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {EndpointDoesNotExist, ShouldBeConfigured} from "./errors";
import {ApiRepository} from "./repository";


/**
 * @classdesc That class just contains configurations and api repository.
 * It should not be used directly or instantialed through `new`.
 * Instead use `getApi()` to get api repository object and
 * `ApiManagerSingleton.getInstance()` if you realy need instance of that class.
 *
 * @property {ApiRepository} #api - contains api repository object.
 * @property {string} host - contains host name.
 * @property {object | Function} commonHeaders - contains headers.
 * @property {ApiEndpointsRepo} endpointsConfig - contains contains config
 * @property {ApiManagerSingleton} instance - Readonly property contains
 *  singleton inctsnce.
 *
 * */
export class ApiManagerSingleton {
  #api;

  /** Should not be used directly. */
  constructor() {
    if (ApiManagerSingleton.hasOwnProperty('instance')) {
      return ApiManagerSingleton.instance;
    } else {
      this.host = "";
      this.config = {};
      this.commonHeaders = {};
      this.axiosConfig = {};

      Object.defineProperty(ApiManagerSingleton, 'instance', {
        value: this,
        enumerable: false,
        writable: false,
        configurable: false
      });
    }
  }

  /** Method returns ApiManagerSingleton instance. Shoud be called instead
   * of constructor.
   *
   * @returns {ApiManagerSingleton}
   * */
  static getInstance() {
    if (ApiManagerSingleton.hasOwnProperty('instance')) {
      return ApiManagerSingleton.instance;
    } else {
      return new ApiManagerSingleton();
    }
  }

  /** Uses to get get api repository object.
   *
   * @returns {ApiRepository}
   * */
  static getApi() {
    const apiManager = ApiManagerSingleton.getInstance();

    if (apiManager)
      return apiManager.api;
    else {
      throw new ShouldBeConfigured();
    }
  }

  get api() {
    return this.#api;
  }

  /** Create new api repository and wrap it in Proxy with custom getter. */
  set api(apiRepository) {
    /** Getter autocreates on the fly properties with api resources due to api
     *   config.
     * If resource already exists, just returns it.
     *
     * Sort of metaprogramming thing.
     *
     * @param {ApiRepository} target - Api repository object.
     * @param {string} name - Property name.
     *
     * @returns {ApiResource} Some object extends BaseApiResource.
     * */
    const proxyGetter = (target, name) => {
      const apiManager = ApiManagerSingleton.getInstance();

      if (!(name in target)) {
        if (name in apiManager.config) {
          target.createResource(
            name,
            apiManager.config[name].path,
            apiManager.config[name]._class
          );

        } else {
          throw new EndpointDoesNotExist(
            name,
            {target, config: apiManager.config}
          );
        }
      }

      return target[name];
    }

    this.#api = new Proxy(apiRepository, {get: proxyGetter});
  }

  /** Configure instance.
   *
   * @param {string} [host] - Your RESTApi base url or host. Can be empty string.
   * @param {Array&lt;string|ApiConfig>} [config] - Api resources config.
   * @param {object | Function} commonHeaders - You can set some headers wich
   *  will used in any request or provide a callback, wich hould generate some
   *  headers for any request.
   * @param {AxiosRequestConfig} [axiosConfig] - You can configure axios directly.
   * */
  configure(host, config, commonHeaders, axiosConfig) {
    this.host = (host !== undefined)
      ? host
      : this.host;

    this.config = (config !== undefined)
      ? ApiManagerSingleton.parseConfig(config)
      : this.config;

    this.commonHeaders = (commonHeaders !== undefined)
      ? commonHeaders
      : this.commonHeaders;

    this.axiosConfig = (axiosConfig !== undefined)
      ? {...axiosConfig}
      : this.axiosConfig;

    this.api = new ApiRepository(this.host, this.commonHeaders, this.axiosConfig);
  }

  static parseConfig(config) {
    return Object.assign({}, ...config.map((configItem) => {
      if (typeof configItem === "string") {
        return {[configItem]: {path: configItem}};
      } else {
        return {
          [configItem.name]: {
            path: configItem.path ? configItem.path : configItem.name,
            _class: configItem._class
          }
        }
      }
    }));
  }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ApiManagerSingleton.html">ApiManagerSingleton</a></li><li><a href="ApiRepository.html">ApiRepository</a></li><li><a href="ApiResource.html">ApiResource</a></li><li><a href="UrlConstructor.html">UrlConstructor</a></li></ul><h3>Global</h3><ul><li><a href="global.html#configureApi">configureApi</a></li><li><a href="global.html#getApi">getApi</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Wed Jul 14 2021 14:02:56 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
